<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Attrack ‚Äî FYBFM Edition</title>
<link rel="manifest" href="manifest.json">
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
:root{
  --bg: #f4f6ff;
  --bg-soft: #fafbff;
  --card-bg: #ffffff;
  --border: #e5e7eb;
  --text: #111827;
  --text-soft: #4b5563;
  --muted: #6b7280;
  --accent: #4f46e5;
  --accent-soft: #eef2ff;
  --danger: #b91c1c;
  --danger-soft: #fee2e2;
  --shadow: 0 4px 18px rgba(0,0,0,0.08);
}

body.dark{
  --bg: #020617;
  --bg-soft: #020617;
  --card-bg: #0b1120;
  --border: #1f2937;
  --text: #e5e7eb;
  --text-soft: #cbd5f5;
  --muted: #9ca3af;
  --accent: #6366f1;
  --accent-soft: #111827;
  --danger: #ef4444;
  --danger-soft: #7f1d1d;
  --shadow: 0 4px 18px rgba(15,23,42,0.9);
}

/* ---------------- Global / theme variables ---------------- */
html, body {
  scrollbar-width: thin;
  scrollbar-color: var(--accent) var(--bg-soft);
}
html.dark {
  scrollbar-color: var(--accent) #020617;
}
/* WebKit scrollbar ‚Äî must be on html */
html::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

html::-webkit-scrollbar-track {
  background: var(--bg-soft);
}

html::-webkit-scrollbar-thumb {
  background: var(--accent);
  border-radius: 999px;
}

/* Dark mode (NOW WORKS) */
html.dark::-webkit-scrollbar-track {
  background: #020617;
}

html.dark::-webkit-scrollbar-thumb {
  background: #6366f1;
}

/* -------- View switching (IMPORTANT FIX) -------- */
.view {
  display: none;
}

.view.active {
  display: block;
}
/* ---------------- Daily View ‚Äì Lectures panel polish ---------------- */

/* Soften the section title */
#dayView h3 {
  font-size: 0.95rem;
  font-weight: 600;
  letter-spacing: 0.2px;
  margin-bottom: 10px;
}

/* Make the "Showing lectures for" line calmer */
#selectedDateLabel {
  font-size: 0.78rem;          /* ‚¨Ö smaller */
  font-weight: 500;            /* ‚¨Ö not bold */
  color: var(--muted);         /* ‚¨Ö less contrast */
  letter-spacing: 0.15px;
}

/* Reduce visual shouting of dropdown label */
.filter-row span {
  font-size: 0.75rem;
  color: var(--text-soft);
}

/* Give toolbar breathing room */
.toolbar {
  margin-top: 10px;
  margin-bottom: 12px;
  gap: 8px;
}

/* Slightly relax button appearance */
.toolbar .btn {
  font-size: 0.75rem;
  padding: 5px 9px;
  opacity: 0.92;
}

/* Make table feel less boxed-in */
table {
  margin-top: 8px;
}

/* Reduce table density */
th, td {
  padding: 6px 6px;   /* ‚¨Ö was tight */
}

/* Calm header row */
th {
  font-size: 0.75rem;
  font-weight: 600;
  letter-spacing: 0.3px;
}

/* Make inputs feel lighter */
td input,
td select {
  background: var(--bg);
}

/* Reduce visual dominance of action column */
td .btn.small {
  opacity: 0.85;
}
td .btn.small:hover {
  opacity: 1;
}

/* Add subtle separation below toolbar */
.toolbar::after {
  content: "";
  display: block;
  height: 1px;
  background: var(--border);
  margin-top: 10px;
}

/* ---------------- Timetable input polish ---------------- */

.timetable-table td {
  padding: 6px 4px;
  background: transparent;
}

.timetable-table input[type="number"] {
  width: 42px;
  height: 26px;
  text-align: center;

  border-radius: 8px;
  border: 1px solid var(--border);
  background: var(--bg-soft);

  font-size: 0.75rem;
  font-weight: 500;
  color: var(--text);

  outline: none;
  transition: 
    border-color 0.15s ease,
    background 0.15s ease,
    box-shadow 0.15s ease;
}

/* Hover = subtle affordance */
.timetable-table input[type="number"]:hover {
  border-color: var(--text-soft);
}

/* Focus = clear but calm */
.timetable-table input[type="number"]:focus {
  border-color: var(--accent);
  background: var(--card-bg);
  box-shadow: 0 0 0 1px rgba(79,70,229,0.25);
}

/* Remove browser spinner noise */
.timetable-table input::-webkit-outer-spin-button,
.timetable-table input::-webkit-inner-spin-button {
  -webkit-appearance: none;
  margin: 0;
}
.timetable-table input[type="number"] {
  appearance: textfield;
}

/* ---------------- Base layout ---------------- */
body{
  margin:0;
  padding:16px;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  background: var(--bg);
  color: var(--text);
  transition: background 0.2s ease, color 0.2s ease;
}

h1,h2,h3 { margin:0 0 8px; }

.app{
  max-width:1100px;
  margin:0 auto;
  background: var(--card-bg);
  border-radius:16px;
  padding:16px 20px 24px;
  box-shadow: var(--shadow);
  border:1px solid var(--border);
}

/* ---------------- Header (compact single-row) ---------------- */
.header{
  display:flex;
  flex-wrap:nowrap;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  padding:12px 16px;
  margin-bottom:8px;
  border-bottom:1px solid var(--border);
  border-radius:12px;
  background:transparent;
  box-shadow:none;
}

.title-block{
  display:flex;
  flex-direction:column;
  gap:4px;
  min-width:0;
}

.title{
  font-size:1.12rem;
  font-weight:700;
  display:flex;
  align-items:center;
  gap:8px;
  line-height:1;
}

.badge{
  font-size:0.75rem;
  padding:2px 8px;
  border-radius:999px;
  background:var(--accent-soft);
  color:var(--accent);
}

/* greeting (cheer) */
.cheer{
  font-size:0.88rem;
  color:var(--text-soft);
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
  max-width:56vw;
}
.cheer span{ font-weight:600; }

/* right-hand summary */
.summary{
  text-align:right;
  font-size:0.92rem;
  min-width:230px;
  max-width:42%;
}
.summary-main{ font-weight:700; font-size:1rem; color:var(--accent); }
.summary-sub{ font-size:0.8rem; color:var(--muted); }

/* ---------------- Nav ---------------- */
.nav{
  display:flex;
  gap:8px;
  flex-wrap:wrap;
  margin-bottom:10px;
  padding-bottom:6px;
  align-items:center;
  border-bottom:1px solid transparent;
}
.nav-btn{
  border-radius:999px;
  border:none;
  padding:5px 10px;
  font-size:0.8rem;
  cursor:pointer;
  display:inline-flex;
  align-items:center;
  gap:4px;
  background:transparent;
  color:var(--muted);
  transition: background 0.15s ease, color 0.15s ease, transform 0.05s ease;
}
.nav-btn.active{ background:var(--accent-soft); color:var(--accent); transform:translateY(-0.5px); }
.nav-spacer{ flex:1; }

.dark-toggle{
  border-radius:999px;
  border:1px solid var(--border);
  padding:4px 9px;
  font-size:0.8rem;
  cursor:pointer;
  display:inline-flex;
  align-items:center;
  gap:4px;
  background:var(--bg-soft);
  color:var(--text-soft);
}

/* ---------------- Grid & cards ---------------- */
.grid{
  display:grid;
  grid-template-columns: minmax(260px,320px) 1fr;
  gap:16px;
  margin-bottom:12px;
}
@media (max-width:900px){ .grid{ grid-template-columns:1fr; } .summary{ text-align:left; max-width:100%; } .cheer{ max-width:100%; white-space:normal; } .header{ flex-wrap:wrap; } }

.card{
  border-radius:12px;
  border:1px solid var(--border);
  background:var(--bg-soft);
  padding:12px;
}
.card h3{ font-size:0.95rem; margin-bottom:6px; }

/* ---------------- Inputs, buttons ---------------- */
.field{ margin-bottom:8px; display:flex; flex-direction:column; gap:4px; }
.field label{ font-size:0.8rem; color:var(--text-soft); }

input[type="text"], input[type="date"], select{
  padding:6px 8px;
  border-radius:8px;
  border:1px solid var(--border);
  font-size:0.85rem;
  outline:none;
  background:var(--card-bg);
  color:var(--text);
}
input[type="text"]:focus, input[type="date"]:focus, select:focus{
  border-color:var(--accent);
  box-shadow:0 0 0 1px rgba(79,70,229,0.25);
}

.subjects-list{ display:flex; flex-direction:column; gap:4px; max-height:180px; overflow-y:auto; padding-right:4px; }
.subject-row{ display:flex; align-items:center; gap:4px; flex-wrap:wrap; }
.subject-row input{ flex:1; min-width:140px; }

.btn{
  border-radius:999px;
  border:none;
  padding:6px 10px;
  font-size:0.8rem;
  cursor:pointer;
  display:inline-flex;
  align-items:center;
  gap:4px;
  background:var(--accent);
  color:#fff;
  transition: background 0.15s ease, transform 0.05s ease, opacity 0.1s ease;
}
	  .mobile-only-hero .btn {
  font-family: inherit; /* Fixes out-of-place font */
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 1px;
  background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%); /* Purple-Blue gradient */
  border: none;
  box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.4);
  transition: all 0.3s ease;
}

.mobile-only-hero .btn:active {
  transform: scale(0.95);
  box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.4);
}

.btn.secondary{ background:#e5e7eb; color:#111827; }
body.dark .btn.secondary{ background:#111827; color:#e5e7eb; }
.btn.danger{ background:var(--danger); }
.btn.small{ padding:4px 7px; font-size:0.75rem; border-radius:999px; }
.btn:hover{ background:#4338ca; transform:translateY(-0.5px); }
.btn.secondary:hover{ background:#d1d5db; }
body.dark .btn.secondary:hover{ background:#1f2937; }
.btn.danger:hover{ background:#991b1b; }
.btn:disabled{ opacity:0.5; cursor:not-allowed; transform:none; }

/* ---------------- Calendar ---------------- */
.calendar{ margin-top:4px; border-radius:12px; border:1px solid var(--border); background:var(--card-bg); padding:8px; }
.cal-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:6px; font-size:0.8rem; }
.cal-grid{ display:grid; grid-template-columns:repeat(7,1fr); gap:4px; font-size:0.75rem; }
.cal-dow{ text-align:center; font-weight:600; color:var(--muted); }
.cal-cell{ height:26px; border-radius:8px; text-align:center; line-height:26px; cursor:pointer; position:relative; border:1px solid transparent; }
.cal-cell.disabled{ cursor:default; color:#9ca3af; }
.cal-cell.has-lectures::after{ content:""; position:absolute; bottom:3px; left:50%; width:6px; height:6px; border-radius:999px; transform:translateX(-50%); background:#22c55e; }
.cal-cell.selected{ background:var(--accent); color:#fff; border-color:var(--accent); }
.cal-cell.today{ border-color:var(--text-soft); }

/* ---------------- Tables & small UI ---------------- */
.toolbar{ display:flex; flex-wrap:wrap; gap:6px; align-items:center; margin-bottom:6px; font-size:0.8rem;}
.toolbar span{ color:var(--text-soft); }
table{ width:100%; border-collapse:collapse; font-size:0.8rem; margin-top:4px; }
th,td{ border:1px solid var(--border); padding:4px; text-align:left; vertical-align:middle; }
th{ background:var(--accent-soft); font-weight:600; color:var(--text-soft); }
td input[type="text"], td input[type="date"], td select{ width:100%; box-sizing:border-box; font-size:0.78rem; padding:3px 4px; }
td .center{ text-align:center; }

.tag{ font-size:0.7rem; padding:1px 6px; border-radius:999px; background:var(--danger-soft); color:var(--danger); }
.lectures-empty, .hint{ font-size:0.75rem; color:var(--muted); margin-top:4px; }

/* ---------------- Home & stats ---------------- */
.home-grid{ display:grid; grid-template-columns: minmax(220px,1.2fr) minmax(260px,1.8fr); gap:12px; }
@media (max-width:900px){ .home-grid{ grid-template-columns:1fr; } }

.pill{ display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:999px; background:var(--accent-soft); color:var(--accent); font-size:0.85rem; margin-top:4px; }
#overallPillText{ font-weight:700; margin-left:4px; }

.subject-stats-list{ display:flex; flex-direction:column; gap:6px; max-height:260px; overflow-y:auto; padding-right:4px; }
.subject-stat-row{ display:flex; align-items:center; justify-content:space-between; gap:8px; font-size:0.8rem; padding:6px 8px; border-radius:8px; background:var(--card-bg); border:1px solid var(--border); }
.subject-stat-name{ font-weight:600; width:90px; flex-shrink:0; }
.subject-stat-bar{ flex:1; margin:0 8px; height:6px; border-radius:999px; background:var(--bg-soft); overflow:hidden; }
.subject-stat-bar-inner{ height:100%; border-radius:999px; background:#22c55e; }
.subject-stat-meta{ font-size:0.75rem; color:var(--muted); white-space:nowrap; }

/* ---------------- Timetable ---------------- */
.timetable-table{ width:100%; border-collapse:collapse; font-size:0.78rem; margin-top:4px; }
.timetable-table th, .timetable-table td{ border:1px solid var(--border); padding:4px 6px; text-align:center; }
.timetable-table th{ background:var(--accent-soft); }

/* ---------------- Footer ---------------- */
.footer{ margin-top:16px; font-size:0.7rem; color:var(--muted); display:flex; flex-wrap:wrap; align-items:center; justify-content:space-between; gap:6px; }
.version-badge{ padding:2px 8px; border-radius:999px; background:var(--accent-soft); color:var(--accent); font-size:0.7rem; }
.footer-credit{ text-align:right; opacity:0.9; }
/* ---- Tutorial reminder tooltip ---- */
.tutorial-reminder {
  position: absolute;
  background: var(--card-bg);
  color: var(--text);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 8px 10px;
  font-size: 0.75rem;
  box-shadow: var(--shadow);
  z-index: 1600;
  max-width: 200px;
}

.tutorial-reminder::after {
  content: "";
  position: absolute;
  top: 50%;
  left: -6px;
  transform: translateY(-50%);
  border-width: 6px;
  border-style: solid;
  border-color: transparent var(--card-bg) transparent transparent;
}

/* ---------------- Tutorial modal styles ---------------- */
#tutorialModalBackdrop{
  position:fixed;
  inset:0;
  background:rgba(2,6,23,0.6);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:1200;
  padding:20px;
  display:none; /* hidden by default */
}
#tutorialModal{
  width:min(760px,98%);
  max-height:86vh;
  overflow-y:auto;
  background:var(--card-bg);
  color:var(--text);
  border-radius:12px;
  border:1px solid var(--border);
  box-shadow:var(--shadow);
  padding:18px;
  font-size:0.92rem;
}
#tutorialModal h2{ margin-top:0; font-size:1.1rem; }
#tutorialModal ol{ padding-left:1.1rem; margin:8px 0 12px 0; }
.tutorial-step{ margin-bottom:8px; }
#tutorialActions{ display:flex; gap:8px; justify-content:flex-end; margin-top:12px; flex-wrap:wrap; }
#tutorialModal .btn{ font-size:0.85rem; padding:7px 10px; }
#tutorialDismissCheckbox{ margin-right:8px; transform:translateY(1px); }
#tutorialFooterNote{ margin-top:8px; color:var(--muted); font-size:0.82rem; }
@media (max-width:700px){ #tutorialModal{ padding:12px; font-size:0.9rem; } }

/* ---------------- Compact header helpers & stray-popup fix ---------------- */
/* Make header act as a single horizontal bar and keep nav below */
.header{ padding:10px 12px; margin-bottom:8px; border-radius:10px; }
.title{ font-size:1.08rem; }
.cheer{ font-size:0.88rem; max-width:56vw; }

/* Reduce overall padding slightly */
.app{ padding:12px 16px 18px; }
.card{ padding:10px; }
.home-grid{ gap:10px; }

/* Hide any accidental empty modal element or stray popup */
#tutorialModalBackdrop[style*="display:flex"] > #tutorialModal:empty,
div.popup-dot { display:none !important; }

/* Slightly lighter modal backdrop if shown */
#tutorialModalBackdrop{ background:rgba(2,6,23,0.45); }
#tutorialModal{ max-width:760px; margin:0 12px; }

/* Responsive tweaks */
@media (max-width:900px){
  .header{ flex-wrap:wrap; }
  .cheer{ max-width:100%; white-space:normal; }
  .summary{ width:100%; text-align:left; margin-top:6px; }
}
/* ---------------- Guided tutorial spotlight ---------------- */

.tour-backdrop {
  position: fixed;
  inset: 0;
  background: rgba(2, 6, 23, 0.6);
  z-index: 1500;
}

.tour-spotlight {
  position: absolute;
  border-radius: 12px;
  box-shadow:
    0 0 0 9999px rgba(2, 6, 23, 0.6),
    0 0 0 3px var(--accent);
  pointer-events: none;
  transition: all 0.25s ease;
  z-index: 1501;
}

.tour-tooltip {
  position: absolute;
  max-width: 260px;
  background: var(--card-bg);
  color: var(--text);
  border-radius: 10px;
  padding: 10px 12px;
  box-shadow: var(--shadow);
  font-size: 0.82rem;
  z-index: 1502;
}

.tour-tooltip h4 {
  margin: 0 0 6px;
  font-size: 0.85rem;
}

.tour-tooltip button {
  margin-top: 8px;
}
@media (max-width: 768px) {
  .tour-tooltip {
    border-radius: 14px;
    font-size: 0.85rem;
    box-shadow: 0 -10px 30px rgba(0,0,0,0.35);
  }
}
.share-btn {
  padding: 4px 10px;
  border-radius: 999px;
  border: 1px solid var(--border);
  background: var(--bg-soft);
  color: var(--text-soft);
  font-size: 0.75rem;
  font-weight: 500;
  line-height: 1;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  gap: 4px;
}

.share-btn:hover {
  background: var(--accent-soft);
  color: var(--accent);
}
/* ---------- Mobile quick fix: sticky footer ---------- */
@media (max-width: 768px) {
  .footer {
    position: sticky;
    bottom: 0;
    z-index: 50;

    background: var(--card-bg);
    border-top: 1px solid var(--border);

    padding: 8px 10px;
    margin-top: 12px;
  }

  /* prevent content from hiding behind footer */
  .app {
    padding-bottom: 70px;
  }
}
@media (max-width: 768px) {
  .footer {
    position: sticky;
    bottom: 0;
    z-index: 50;
    background: var(--card-bg);
    border-top: 1px solid var(--border);
    padding: 8px 10px;
  }

  .footer-actions {
    flex-direction: column;
    align-items: stretch;
  }

  .footer-actions .share-btn {
    width: 100%;
    justify-content: center;
  }

  .footer-actions .version-badge {
    width: 100%;
    text-align: center;
  }

  .app {
    padding-bottom: 80px;
  }
}

.footer-actions {
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
}

@media (max-width: 768px) {
  .footer {
    position: sticky;
    bottom: 0;
    z-index: 50;
    background: var(--card-bg);
    border-top: 1px solid var(--border);
    padding: 8px 10px;
  }

  .footer-actions {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .footer-actions .share-btn,
  .footer-actions .version-badge {
    width: 100%;
    text-align: center;
    justify-content: center;
  }

  .app {
    padding-bottom: 90px; /* prevents footer overlap */
  }
}

/* Mobile-Specific Vibe Fixes */
@media (max-width: 600px) {
  .app-container {
    flex-direction: column; /* Stack vertically instead of side-by-side */
    height: auto;
    padding-bottom: 80px; /* Make room for the bottom nav */
  }

  .sidebar {
    width: 100% !important;
    height: auto;
    position: fixed;
    bottom: 0;
    left: 0;
    z-index: 1000;
    flex-direction: row; /* Turn the vertical menu into a horizontal row */
    justify-content: space-around;
    padding: 10px 5px;
    border-right: none;
    border-top: 1px solid var(--border);
    background: var(--card-bg);
  }

  .sidebar-nav {
    flex-direction: row !important; /* Icons sit side-by-side */
    width: 100%;
    gap: 5px;
  }

  .nav-btn {
    flex: 1;
    justify-content: center;
    padding: 12px 5px;
    font-size: 12px;
  }

  /* Hide the title/logo in the sidebar on mobile to save space */
  .sidebar h2 { display: none; }

  /* Make the main content take the full screen width */
  .main-content {
    padding: 15px;
  }
}
@media (max-width: 600px) {
  /* This prevents the horizontal scroll 'Wideness' */
  html, body {
    overflow-x: hidden; 
    width: 100%;
    margin: 0;
    padding: 0;
  }

  .main-content {
    margin-left: 0 !important;
    width: 100% !important;
    box-sizing: border-box; /* Crucial: includes padding in the width calculation */
    padding: 15px !important;
  }

  /* Fix the tables from stretching the screen */
  .table-container {
    overflow-x: auto; /* Allows only the table to scroll, not the whole app */
    width: 100%;
    -webkit-overflow-scrolling: touch;
  }

  /* Make the bottom buttons bigger for thumbs */
  .nav-btn {
    height: 100%;
    font-size: 13px !important; /* Slightly bigger text */
    font-weight: 600;
  }
}
@media (min-width: 601px) {
  .mobile-only-hero { display: none; }
}
	  @media (max-width: 600px) {
  /* 1. Add space between the main sections */
  .card, .stats-grid, .view, .view-header {
    margin-bottom: 24px !important; 
    gap: 15px !important;
  }

  /* 2. Make the Subject Stats look like clean cards, not a tight list */
  .subject-stat-row {
    background: var(--bg-soft);
    padding: 15px;
    border-radius: 12px;
    margin-bottom: 10px;
    border: 1px solid var(--border);
  }

  /* 3. Fix the "Squashed" Table problem */
  /* This turns each row into its own little 'chunk' instead of a tight line */
  #lecturesTableBody tr {
    display: block;
    background: var(--card-bg);
    border: 1px solid var(--border);
    border-radius: 12px;
    margin-bottom: 15px;
    padding: 10px;
  }

  #lecturesTableBody td {
    display: flex;
    justify-content: space-between;
    align-items: center;
    border: none;
    padding: 8px 5px;
  }

  /* Add labels so you know what each row in the 'chunk' is */
  #lecturesTableBody td::before {
    content: attr(data-label); /* We will add this in the HTML next */
    font-weight: bold;
    color: var(--muted);
    font-size: 0.8rem;
  }
}
@media (max-width: 600px) {
  .sidebar {
    background: rgba(var(--card-bg-rgb), 0.8);
    backdrop-filter: blur(10px);
    padding-bottom: env(safe-area-inset-bottom); /* Fix for iPhones with notches */
  }
  .nav-btn {
    flex-direction: column; /* Icon above text */
    gap: 2px;
  }
}
  </style>
</head>
<body>
  <div class="app">

    <!-- ----------------- Header + Nav (REPLACED) ----------------- -->
    <div class="header">
      <div class="title-block">
        <div class="title">
          üìö Attrack ‚Äî FYBFM Edition
          <span class="badge">Student-first UI</span>
        </div>
        <div id="cheerMessage" class="cheer">
          Welcome! Tell me your name below and we‚Äôll keep your attendance happy and healthy. üòä
        </div>
      </div>

      <div class="summary" aria-live="polite">
        <div class="summary-main" id="summaryMain">0 / 0 lectures tracked</div>
        <div class="summary-sub" id="summarySub">Set your start date and add lectures to begin.</div>
      </div>
    </div>

<div class="nav" role="navigation" aria-label="Main navigation">
  <button class="nav-btn active" data-view="dayView" type="button">üìÖ Daily view</button>
  
  <button class="nav-btn" data-view="homeView" type="button">üè† Home</button>
  
  <button class="nav-btn" data-view="timetableView" type="button">üóì Timetable</button>
  
  <button id="showTutorialNavBtn" class="nav-btn" type="button">üéì Show tutorial</button>
  <div class="nav-spacer"></div>
  <button id="darkToggle" class="dark-toggle" type="button">
    <span id="darkIcon">üåô</span>
    <span id="darkLabel">Dark mode</span>
  </button>
</div>

    <!-- ----------------- end Header + Nav ----------------- -->

    <!-- Tutorial modal (hidden by default) -->
    <div id="tutorialModalBackdrop" aria-hidden="true" style="display:none;">
      <div id="tutorialModal" role="dialog" aria-modal="true" aria-labelledby="tutorialTitle">
        <h2 id="tutorialTitle">Welcome to Attrack ‚Äî quick tutorial</h2>

        <p class="hint">A few quick steps to view and update your attendance. Use the buttons below to try each step in the app.</p>

        
	Welcome! I, Jenish have made this small project as a way for you to start tracking your attendance! Follow the steps below to start managing your attendance effortlessly! 
	The app has been coded such that it has included all lectures conducted so far as on <b>31/12/2025</b> (including the extra ones)!
         <ol>
          <li class="tutorial-step"><strong>Open Daily view & calendar</strong> ‚Äî select a date to view or edit lectures.</li>
          <li class="tutorial-step"><strong>Load lectures for any day</strong> ‚Äî press <code>Load lectures (this day)</code> to generate that day's lectures.</li>
          <li class="tutorial-step"><strong>Mark attendance</strong> ‚Äî toggle the checkbox or use <code>All attended</code>/<code>All absent</code>. You are automatically marked present in any loaded lecture.</li>
          <li class="tutorial-step"><strong>Edit timetable</strong> ‚Äî open <em>Timetable</em> to change weekly counts; changes auto-regenerate.</li>
        </ol>

        <div id="tutorialFooterNote">Tip: To see this tutorial again later, click <strong>Show tutorial</strong> in the top nav.</div>

        <div id="tutorialActions">
          <label style="display:inline-flex;align-items:center;margin-right:auto;">
            <input id="tutorialDismissCheckbox" type="checkbox" />
            Don't show this again
          </label>
          <button id="tutorialCloseBtn" class="btn small">Got it</button>
          <button id="tutorialOpenDayBtn" class="btn small secondary">Open Daily view</button>
        </div>
      </div>
    </div>

    <!-- HOME VIEW -->
    <div id="homeView" class="view active">

      <div class="home-grid">
        <div class="card">
          <h3>Welcome back üëã</h3>
          <div class="field">
            <label for="studentName">Your name</label>
            <input id="studentName" type="text" placeholder="e.g. Jenish, Rocking Math Nerd üòÑ" />
          </div>
          <div class="field">
            <label for="startDate">Start tracking from</label>
            <input id="startDate" type="date" />
          </div>
                  <div class="hint" style="margin-top:8px;">
            Set your semester start date (dd-mm-yyyy in text).  
            You can also load any single future day from the Daily view.
          </div>
         <div id="finalAttendanceSummary">
  <div id="overallPill" class="pill" style="margin-top:12px;">
    üéØ Overall attendance: <span id="overallPillText">0%</span>
  </div>
  <div id="targetMessage" class="hint" style="margin-top:8px;"></div>
</div>

        </div>

        <div class="card">
          <h3>Per-subject overview üìä</h3>
          <div class="subject-stats-list" id="subjectStatsList"></div>
          <div class="hint" style="margin-top:8px;">
            These stats are based on all generated + manual lectures since your start date.  
            You can tweak lectures in the Daily view.
          </div>
        </div>
      </div>
    </div>

    <!-- DAILY VIEW -->
<div class="mobile-only-hero" style="margin-bottom: 20px;">
  <button class="btn" onclick="document.getElementById('loadDayBtn').click()" 
          style="width: 100%; height: 60px; font-size: 1.1rem; background: var(--accent); color: white; border-radius: 12px; box-shadow: var(--shadow);">
    ‚ö° Load Today's Lectures
  </button>
</div>
    <div id="dayView" class="view">
      <div class="grid">
        <div>
          <div class="card" style="margin-bottom:8px;">
            <h3>Subjects üß†</h3>
            <div class="subjects-list" id="subjectsList"></div>
            <button class="btn small secondary" id="addSubjectBtn" type="button" style="margin-top:8px;">+ Add subject</button>
            <div class="hint" style="margin-top:8px;">
              These start with your timetable, but you can rename them or add new ones.
            </div>
          </div>

          <div class="card">
            <h3>Calendar üóìÔ∏è</h3>
            <div class="calendar">
              <div class="cal-header">
                <button class="btn small secondary" id="prevMonthBtn" type="button">‚óÄ</button>
                <div id="monthLabel"></div>
                <button class="btn small secondary" id="nextMonthBtn" type="button">‚ñ∂</button>
              </div>
              <div class="cal-grid" id="calGrid"></div>
            </div>
            <div class="hint" style="margin-top:8px;">
              Tap on a date to see or edit the lectures for that day. Green dots = days with lectures.  
              For future days, use ‚ÄúLoad lectures (this day)‚Äù below.
            </div>
          </div>
        </div>

        <div class="card">
          <h3>Lectures & attendance ‚úÖ</h3>

          <div class="filter-row">
            <span id="selectedDateLabel"></span>
            <span style="flex:1;"></span>
            <span>Filter subject:</span>
            <select id="subjectFilter">
              <option value="">All</option>
            </select>
          </div>

          <div class="toolbar">
            <button class="btn small secondary" id="loadDayBtn" type="button">Load lectures (this day)</button>
            <button class="btn small" id="addLectureBtn" type="button">+ Add lecture</button>
            <button class="btn small secondary" id="addSpecialLectureBtn" type="button">+ Add special lecture</button>
            <button class="btn small" id="markAllAttendedBtn" type="button">All attended</button>
            <button class="btn small secondary" id="markAllAbsentBtn" type="button">All absent</button>
          </div>

          <table>
            <thead>
              <tr>
                <th style="width: 98px;">Date</th>
                <th style="width: 120px;">Subject</th>
                <th>Lecture title / note</th>
                <th style="width: 70px;">Special</th>
                <th style="width: 80px;">Attended?</th>
                <th style="width: 60px;">Remove</th>
              </tr>
            </thead>
            <tbody id="lecturesTableBody"></tbody>
          </table>
          <div id="lecturesEmpty" class="lectures-empty"></div>
          <div class="hint" style="margin-top:8px;">
            All new lectures are marked as attended by default.  
            ‚ÄúAll attended‚Äù / ‚ÄúAll absent‚Äù flips the whole day in one click.
          </div>
        </div>
      </div>
    </div>

    <!-- TIMETABLE VIEW -->
    <div id="timetableView" class="view">
      <div class="card">
        <h3>Your timetable editor üóì</h3>
        <div class="hint">
          Set how many lectures of each subject happen on each day.  
          Changing this will auto-regenerate lectures (old manual + special ones stay).
        </div>
        <div style="overflow-x:auto; margin-top:6px;">
          <table class="timetable-table">
            <thead>
              <tr>
                <th style="text-align:left;">Subject</th>
                <th>Mon</th><th>Tue</th><th>Wed</th><th>Thu</th><th>Fri</th><th>Sat</th>
              </tr>
            </thead>
            <tbody id="timetableBody"></tbody>
          </table>
        </div>
      </div>
    </div>

   <div class="footer">
  <div class="footer-actions">
    <span class="version-badge">Attrack v1.0 ‚Äî FYBFM Edition (Dec 2025)</span>

    <button id="exportAttendanceBtn" class="share-btn">
  üìä Export attendance
</button>

<button id="shareAppBtn" class="share-btn">
  üì§ Share Attrack
</button>


    <span id="shareStatus"
          style="display:none; font-size:0.7rem; color:#16a34a;">
      Link copied!
    </span>
  </div>

  <div class="footer-credit">
   Made with üíª by Jenish, ChatGPT &amp; Gemini
  </div>
</div>

  </div>

<script>
  (function () {
    const STORAGE_KEY = "attrack_FYBFM_v1";
    const THEME_KEY   = "attrack_theme";
    const VIEW_KEY    = "attrack_lastView";
    const TARGET_ATTENDANCE = 0.75; 

    // ---------------- Export Attendance (CSV) ----------------
    function exportAttendanceCSV() {
      if (!state || !Array.isArray(state.lectures) || state.lectures.length === 0) {
        alert("No attendance data to export yet.");
        return;
      }

      const subjectMap = {};
      state.subjects.forEach(s => {
        subjectMap[s.id] = s.name || "Unknown";
      });

      const headers = ["Date", "Subject", "Lecture Title", "Attended", "Special", "Auto Generated"];
      const rows = state.lectures.slice().sort((a, b) => (a.date > b.date ? 1 : -1)).map(lec => [
        lec.date || "",
        subjectMap[lec.subjectId] || "",
        (lec.title || "").replace(/"/g, '""'),
        lec.attended ? "Yes" : "No",
        lec.isSpecial ? "Yes" : "No",
        lec.autoGenerated ? "Yes" : "No"
      ]);

      let csv = headers.join(",") + "\n";
      rows.forEach(r => { csv += r.map(v => `"${v}"`).join(",") + "\n"; });

      const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `Attrack_Attendance_${state.studentName || "Student"}_${toISODate(new Date())}.csv`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }
    const exportBtn = document.getElementById("exportAttendanceBtn");
    if (exportBtn) exportBtn.addEventListener("click", exportAttendanceCSV);

    // Defensive cleanup
    (function removeAccidentalTextNodes() {
      try {
        const walker = document.createTreeWalker(document.body, NodeFilter.SHOW_TEXT, null, false);
        const toRemove = [];
        while (walker.nextNode()) {
          const t = walker.currentNode.nodeValue && walker.currentNode.nodeValue.trim();
          if (t === "<" || t === "..." || t === "‚Ä¶") toRemove.push(walker.currentNode);
        }
        toRemove.forEach(n => n.parentNode && n.parentNode.removeChild(n));
      } catch (e) { }
    })();

    // üéØ Rules & Holidays
    // Updated with Winter Break (Dec 25 - Dec 31)
const HOLIDAYS = new Set([
  "2025-11-05", "2025-12-06", 
  "2025-12-25", "2025-12-26", "2025-12-27", 
  "2025-12-28", "2025-12-29", "2025-12-30", "2025-12-31"
]);

    const ZERO_LECTURE_DAYS = new Set(["2025-12-10"]);
    const EXTRA_LECTURES = [
      { date: "2025-11-21", subjectId: "sub-fa", title: "Extra lecture" },
      { date: "2025-11-29", subjectId: "sub-ffs",  title: "FFS extra lecture" },
      { date: "2025-12-01", subjectId: "sub-mst",  title: "MST extra lecture" },
      { date: "2025-12-08", subjectId: "sub-mst",  title: "MST extra lecture" },
    ];
    const PER_SUBJECT_CANCEL = [
      { date: "2025-11-04", subjectId: "sub-cs" },
      { date: "2025-11-21", subjectId: "sub-ppbi" },
      { date: "2025-11-27", subjectId: "sub-ffs" },
      { date: "2025-11-28", subjectId: "sub-ppbi" },
      { date: "2025-11-29", subjectId: "sub-ppbi" },
      { date: "2025-11-29", subjectId: "sub-ui" },
      { date: "2025-12-05", subjectId: "sub-cs" },
      { date: "2025-12-23", subjectId: "sub-cs" },
    ];

    // Helpers
    function toISODate(d) {
      const year = d.getFullYear();
      const month = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${year}-${month}-${day}`;
    }
    function parseISO(dateStr) {
      const parts = dateStr ? dateStr.split("-") : null;
      if (!parts || parts.length !== 3) return new Date();
      return new Date(Number(parts[0]), Number(parts[1]) - 1, Number(parts[2]));
    }
    function formatDisplayDate(iso) {
      const [y, m, d] = iso.split("-");
      return `${d}-${m}-${y}`;
    }
    function escapeHtml(str) {
      return String(str).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;");
    }
    function genId(prefix) {
      return prefix + "-" + Math.random().toString(36).slice(2,9) + "-" + Date.now().toString(36);
    }

    function defaultState() {
      const isoStart = "2025-11-03";
      return {
        isInitialized: false,
        studentName: "",
        startDate: isoStart,
        subjects: [
          { id: "sub-fa",   name: "FA",    schedule: { weeklyPattern: [{day:1,count:1},{day:3,count:1},{day:6,count:1}] } },
          { id: "sub-ffs",  name: "FFS",   schedule: { weeklyPattern: [{day:1,count:1},{day:4,count:1}] } },
          { id: "sub-mst",  name: "MST",   schedule: { weeklyPattern: [{day:1,count:1},{day:6,count:1}] } },
          { id: "sub-cs",   name: "CS",    schedule: { weeklyPattern: [{day:2,count:1},{day:5,count:1}] } },
          { id: "sub-dra",  name: "Drama", schedule: { weeklyPattern: [{day:2,count:1},{day:4,count:2}] } },
          { id: "sub-ppbi", name: "PPBI",  schedule: { weeklyPattern: [{day:2,count:1},{day:3,count:1},{day:5,count:1}] } },
          { id: "sub-be",   name: "BE",    schedule: { weeklyPattern: [{day:2,count:1},{day:3,count:1}] } },
          { id: "sub-eeb",  name: "EEB",   schedule: { weeklyPattern: [{day:2,count:1},{day:5,count:1}] } },
          { id: "sub-ui",   name: "UI",    schedule: { weeklyPattern: [{day:3,count:1},{day:6,count:1}] } },
          { id: "sub-smo",  name: "SMO",   schedule: { weeklyPattern: [{day:4,count:2}] } },
        ],
        lectures: []
      };
    }

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return defaultState();
        const parsed = JSON.parse(raw || "{}");
        const defaults = defaultState();

        if (!Array.isArray(parsed.subjects) || parsed.subjects.length === 0) {
          parsed.subjects = defaults.subjects.map(s => ({
            id: s.id, name: s.name,
            schedule: s.schedule ? JSON.parse(JSON.stringify(s.schedule)) : { weeklyPattern: [] }
          }));
        } else {
          // Merge logic to ensure schedule structure exists
          parsed.subjects = parsed.subjects.map(s => {
            const out = {
              id: s.id || (s.name ? ("sub-" + s.name.toLowerCase().replace(/[^a-z0-9]+/g,"-")) : genId("sub")),
              name: s.name || "Subject",
              schedule: null
            };
            if (s && s.schedule && Array.isArray(s.schedule.weeklyPattern)) {
              out.schedule = s.schedule;
            } else {
              const match = defaults.subjects.find(d => (d.id && d.id === s.id) || (d.name && s.name && d.name.toLowerCase() === s.name.toLowerCase()));
              out.schedule = match ? JSON.parse(JSON.stringify(match.schedule)) : { weeklyPattern: [] };
            }
            return out;
          });
        }
        if (!Array.isArray(parsed.lectures)) parsed.lectures = [];
        if (!parsed.startDate) parsed.startDate = defaults.startDate;
        if (typeof parsed.isInitialized !== "boolean") parsed.isInitialized = false;
        return parsed;
      } catch (e) {
        console.error("Failed to load state", e);
        return defaultState();
      }
    }

    let state = loadState();
    let currentMonthDate = new Date();
    let selectedDate = new Date();

    // Elements
    const cheerMessageEl = document.getElementById("cheerMessage");
    const summaryMainEl = document.getElementById("summaryMain");
    const summarySubEl = document.getElementById("summarySub");
    const homeView = document.getElementById("homeView");
    const dayView = document.getElementById("dayView");
    const timetableView = document.getElementById("timetableView");
    const navButtons = Array.from(document.querySelectorAll(".nav-btn"));
    const studentNameInput = document.getElementById("studentName");
    const startDateInput = document.getElementById("startDate");
    const overallPillText = document.getElementById("overallPillText");
    const subjectStatsList = document.getElementById("subjectStatsList");
    const targetMessageEl = document.getElementById("targetMessage");
    const subjectsListEl = document.getElementById("subjectsList");
    const addSubjectBtn = document.getElementById("addSubjectBtn");
    const monthLabelEl = document.getElementById("monthLabel");
    const calGridEl = document.getElementById("calGrid");
    const prevMonthBtn = document.getElementById("prevMonthBtn");
    const nextMonthBtn = document.getElementById("nextMonthBtn");
    const selectedDateLabelEl = document.getElementById("selectedDateLabel");
    const subjectFilterEl = document.getElementById("subjectFilter");
    const loadDayBtn = document.getElementById("loadDayBtn");
    const addLectureBtn = document.getElementById("addLectureBtn");
    const addSpecialLectureBtn = document.getElementById("addSpecialLectureBtn");
    const markAllAttendedBtn = document.getElementById("markAllAttendedBtn");
    const markAllAbsentBtn = document.getElementById("markAllAbsentBtn");
    const lecturesTableBodyEl = document.getElementById("lecturesTableBody");
    const lecturesEmptyEl = document.getElementById("lecturesEmpty");
    const timetableBodyEl = document.getElementById("timetableBody");
    const darkToggle = document.getElementById("darkToggle");
    const darkIcon = document.getElementById("darkIcon");
    const darkLabel = document.getElementById("darkLabel");

    function saveState() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      renderSummary();
      renderSubjectStats();
    }
    function setTheme(theme) {
      if (theme === "dark") {
        document.documentElement.classList.add("dark");
        document.body.classList.add("dark");
        darkIcon.textContent = "‚òÄÔ∏è";
        darkLabel.textContent = "Light mode";
      } else {
        document.documentElement.classList.remove("dark");
        document.body.classList.remove("dark");
        darkIcon.textContent = "üåô";
        darkLabel.textContent = "Dark mode";
      }
      localStorage.setItem(THEME_KEY, theme);
    }

    // ---------- Generation Logic ----------
    function regenerateFromSchedules() {
      const start = parseISO(state.startDate || toISODate(new Date()));
      const today = new Date(); today.setHours(0,0,0,0);
      
      const manualLectures = state.lectures.filter(l => !l.autoGenerated);
      const existingAuto = state.lectures.filter(l => l.autoGenerated);
      const autoByKey = {};
      
      existingAuto.forEach(lec => {
        if (!lec.date) return;
        const d = parseISO(lec.date); d.setHours(0,0,0,0);
        if (d < start || d > today) return;
        const key = `${lec.date}|${lec.subjectId || ""}`;
        if (!autoByKey[key]) autoByKey[key] = [];
        autoByKey[key].push(lec);
      });

      const newAuto = [];
      let cur = new Date(start); cur.setHours(0,0,0,0);
      let guard = 0;
      
      while (cur <= today && guard < 5000) {
        const iso = toISODate(cur);
        if (!HOLIDAYS.has(iso) && !ZERO_LECTURE_DAYS.has(iso)) {
          const dow = cur.getDay();
          state.subjects.forEach(subj => {
            if (!subj.schedule?.weeklyPattern) return;
            if (PER_SUBJECT_CANCEL.some(c => c.date === iso && c.subjectId === subj.id)) return;
            
            let occurrences = 0;
            subj.schedule.weeklyPattern.forEach(p => { if (p.day === dow) occurrences += (p.count || 1); });
            
            if (occurrences > 0) {
              const key = `${iso}|${subj.id}`;
              const existing = autoByKey[key] || [];
              for (let i = 0; i < occurrences; i++) {
                if (existing[i]) {
                  newAuto.push(existing[i]);
                } else {
                  newAuto.push({
                    id: genId("lec"), date: iso, subjectId: subj.id, title: "", isSpecial: false, attended: true, autoGenerated: true
                  });
                }
              }
            }
          });
        }
        cur.setDate(cur.getDate() + 1);
        guard++;
      }

      const futureAuto = existingAuto.filter(lec => {
        if (!lec.date) return false;
        const d = parseISO(lec.date); d.setHours(0,0,0,0);
        return d > today;
      });

      state.lectures = manualLectures.concat(newAuto, futureAuto);
      applyCancellationsAndExtras();
    }

    function generateLecturesForDateInternal(subj, dateObj, avoidDuplicates) {
      const iso = toISODate(dateObj);
      if (HOLIDAYS.has(iso) || ZERO_LECTURE_DAYS.has(iso)) return;
      const dow = dateObj.getDay();
      let occurrences = 0;
      subj.schedule.weeklyPattern.forEach(p => { if (p.day === dow) occurrences += (p.count || 1); });
      if (occurrences <= 0) return;

      const existingAuto = state.lectures.filter(lec => lec.autoGenerated && lec.date === iso && lec.subjectId === subj.id).length;
      const toAdd = avoidDuplicates ? Math.max(0, occurrences - existingAuto) : occurrences;
      
      for (let i = 0; i < toAdd; i++) {
        state.lectures.push({
          id: genId("lec"), date: iso, subjectId: subj.id, title: "", isSpecial: false, attended: true, autoGenerated: true
        });
      }
    }

    function generateLecturesForDate(isoDate) {
      const d = parseISO(isoDate); d.setHours(0,0,0,0);
      state.subjects.forEach(subj => {
        if (!subj.schedule || !Array.isArray(subj.schedule.weeklyPattern)) return;
        generateLecturesForDateInternal(subj, d, true);
      });
      applyCancellationsAndExtras();
    }

    function ensureMstExtras() {
      const mstSubject = state.subjects.find(s => s.id === "sub-mst");
      if (!mstSubject) return;
      const EXTRA_MST_DATES = ["2025-12-01", "2025-12-08"];
      EXTRA_MST_DATES.forEach(date => {
        const mstAutos = state.lectures.filter(lec => lec.date===date && lec.subjectId===mstSubject.id && lec.autoGenerated===true);
        if (!mstAutos.some(lec => !lec.isSpecial)) {
          state.lectures.push({ id: genId("lec"), date, subjectId: mstSubject.id, title:"", isSpecial:false, attended:true, autoGenerated:true });
        }
        if (!mstAutos.some(lec => lec.isSpecial)) {
          state.lectures.push({ id: genId("lec"), date, subjectId: mstSubject.id, title:"MST extra lecture", isSpecial:true, attended:true, autoGenerated:true });
        }
      });
    }

    function applyCancellationsAndExtras() {
      state.lectures = state.lectures.filter(lec => {
        if (!lec.autoGenerated) return true;
        return !PER_SUBJECT_CANCEL.some(c => c.date===lec.date && c.subjectId===lec.subjectId);
      });
      EXTRA_LECTURES.forEach(extra => {
        if (HOLIDAYS.has(extra.date) || ZERO_LECTURE_DAYS.has(extra.date)) return;
        const exists = state.lectures.some(lec => lec.date===extra.date && lec.subjectId===extra.subjectId && lec.autoGenerated);
        if (!exists) {
          state.lectures.push({ id: genId("lec"), date: extra.date, subjectId: extra.subjectId, title: extra.title || "Extra lecture", isSpecial:true, attended:true, autoGenerated:true });
        }
      });
      ensureMstExtras();
    }

    // ---------- Rendering ----------
    function renderStudent() {
      studentNameInput.value = state.studentName || "";
      startDateInput.value = state.startDate || toISODate(new Date());
      cheerMessageEl.innerHTML = state.studentName 
        ? `Hey <span>${escapeHtml(state.studentName)}</span>! Let‚Äôs keep your attendance streak going strong. üåü`
        : "Welcome! Tell me your name below and we‚Äôll keep your attendance happy and healthy. üòä";
    }

    function renderSubjectsList() {
      subjectsListEl.innerHTML = "";
      subjectFilterEl.innerHTML = "<option value=''>All</option>";
      state.subjects.forEach((subj) => {
        const row = document.createElement("div"); row.className = "subject-row";
        
        const input = document.createElement("input");
        input.type = "text"; input.value = subj.name; input.placeholder = "Subject name";
        
        // FIX: Removed the "Delete all lectures" prompt on rename
        input.addEventListener("change", () => {
          subj.name = input.value.trim();
          saveState();
          renderLectures();
          renderSubjectStats();
          renderTimetable();
          renderSubjectsList(); // refresh dropdowns
        });

        const timetableBtn = document.createElement("button");
        timetableBtn.className = "btn small secondary"; timetableBtn.textContent = "Timetable";
        timetableBtn.addEventListener("click", () => switchView("timetableView"));

        const delBtn = document.createElement("button");
        delBtn.className = "btn small danger"; delBtn.textContent = "‚úï";
        delBtn.addEventListener("click", () => {
          if (!confirm("Remove this subject AND all its lectures?")) return;
          state.subjects = state.subjects.filter(s => s.id !== subj.id);
          state.lectures = state.lectures.filter(lec => lec.subjectId !== subj.id);
          saveState(); renderSubjectsList(); renderLectures(); renderTimetable(); renderSubjectStats();
        });

        row.appendChild(input); row.appendChild(timetableBtn); row.appendChild(delBtn);
        subjectsListEl.appendChild(row);

        const opt = document.createElement("option");
        opt.value = subj.id; opt.textContent = subj.name || "Subject";
        subjectFilterEl.appendChild(opt);
      });
    }

    function renderCalendar() {
      const year = currentMonthDate.getFullYear();
      const month = currentMonthDate.getMonth();
      const firstDay = new Date(year, month, 1).getDay();
      const daysInMonth = new Date(year, month + 1, 0).getDate();
      const monthNames = ["January","February","March","April","May","June","July","August","September","October","November","December"];
      const dow = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
      
      monthLabelEl.textContent = `${monthNames[month]} ${year}`;
      calGridEl.innerHTML = "";
      dow.forEach(d => {
        const el = document.createElement("div"); el.className = "cal-dow"; el.textContent = d; calGridEl.appendChild(el);
      });

      const dateToHasLectures = {};
      state.lectures.forEach(lec => { if (lec.date) dateToHasLectures[lec.date] = true; });

      let dayCounter = 1;
      const todayISO = toISODate(new Date());
      const selectedISO = toISODate(selectedDate);

      for (let i = 0; i < 42; i++) {
        const cell = document.createElement("div"); cell.className = "cal-cell";
        if (i < firstDay || dayCounter > daysInMonth) {
          cell.classList.add("disabled");
        } else {
          const d = dayCounter;
          const iso = `${year}-${String(month + 1).padStart(2, "0")}-${String(d).padStart(2, "0")}`;
          cell.textContent = d;
          if (iso === todayISO) cell.classList.add("today");
          if (iso === selectedISO) cell.classList.add("selected");
          if (dateToHasLectures[iso]) cell.classList.add("has-lectures");
          
          cell.addEventListener("click", () => {
            selectedDate = parseISO(iso);
            renderCalendar();
            renderLectures();
          });
          dayCounter++;
        }
        calGridEl.appendChild(cell);
      }
    }

    function renderLectures() {
      const selectedISO = toISODate(selectedDate);
      selectedDateLabelEl.textContent = `Showing lectures for: ${formatDisplayDate(selectedISO)}`;
      const filterSubId = subjectFilterEl.value || "";
      let todays = state.lectures.filter(lec => lec.date === selectedISO);
      if (filterSubId) todays = todays.filter(lec => lec.subjectId === filterSubId);
      todays.sort((a, b) => (a.id > b.id ? 1 : -1)); // Simple sort by ID (creation order usually)

      lecturesTableBodyEl.innerHTML = "";
      if (todays.length === 0) {
        lecturesEmptyEl.textContent = "No lectures for this day with this filter. Load from timetable or add manually.";
      } else {
        lecturesEmptyEl.textContent = "";
      }

      todays.forEach(lec => {
        const tr = document.createElement("tr");
        
        // Date (hidden power user feature: move lecture)
        const tdDate = document.createElement("td");
        const dateInput = document.createElement("input");
        dateInput.type = "date"; dateInput.value = lec.date;
        dateInput.addEventListener("change", () => { 
          lec.date = dateInput.value || selectedISO; 
          saveState(); renderCalendar(); renderLectures(); 
        });
        tdDate.appendChild(dateInput); tr.appendChild(tdDate);

        // Subject
        const tdSub = document.createElement("td");
        const select = document.createElement("select");
        const blank = document.createElement("option"); blank.value=""; blank.textContent="‚Äî none ‚Äî"; select.appendChild(blank);
        state.subjects.forEach(s => {
          const opt = document.createElement("option"); opt.value=s.id; opt.textContent=s.name; select.appendChild(opt);
        });
        select.value = lec.subjectId || "";
        select.addEventListener("change", () => { lec.subjectId = select.value; saveState(); renderSubjectStats(); });
        tdSub.appendChild(select); tr.appendChild(tdSub);
		tdSub.setAttribute("data-label", "Subject"); // Add this line
        // Title
        const tdTitle = document.createElement("td");
        const tInput = document.createElement("input");
        tInput.type = "text"; tInput.placeholder = "e.g. Tutorial..."; tInput.value = lec.title || "";
        tInput.addEventListener("input", () => { lec.title = tInput.value; saveState(); });
        tdTitle.appendChild(tInput); tr.appendChild(tdTitle);
		tdTitle.setAttribute("data-label", "Topic"); // Add this line
        // Special
        const tdSpec = document.createElement("td"); tdSpec.className = "center";
        if (lec.isSpecial) {
          const tag = document.createElement("span"); tag.className="tag"; tag.textContent="Special"; tdSpec.appendChild(tag); tdSpec.appendChild(document.createElement("br"));
        }
        const specBtn = document.createElement("button"); specBtn.className="btn small secondary"; 
        specBtn.textContent = lec.isSpecial ? "Make normal" : "Make special";
        specBtn.addEventListener("click", () => { lec.isSpecial = !lec.isSpecial; saveState(); renderLectures(); });
        tdSpec.appendChild(specBtn); tr.appendChild(tdSpec);
		tdSpec.setAttribute("data-label", "Type"); // Label it "Type" or "Special"
        // Attendance
        const tdAtt = document.createElement("td"); tdAtt.className = "center";
        const cb = document.createElement("input"); cb.type="checkbox"; cb.checked = !!lec.attended;
        cb.addEventListener("change", () => { lec.attended = cb.checked; saveState(); renderSummary(); renderSubjectStats(); });
        tdAtt.appendChild(cb); tr.appendChild(tdAtt);
		tdAtt.setAttribute("data-label", "Attended?");
        // Remove
        const tdDel = document.createElement("td"); tdDel.className="center";
        const delBtn = document.createElement("button"); delBtn.className="btn small danger"; delBtn.textContent="‚úï";
        delBtn.addEventListener("click", () => {
          if (!confirm("Remove this lecture?")) return;
          state.lectures = state.lectures.filter(x => x.id !== lec.id);
          saveState(); renderLectures(); renderCalendar(); renderSubjectStats(); renderSummary();
        });
        tdDel.appendChild(delBtn); tr.appendChild(tdDel);
		
        lecturesTableBodyEl.appendChild(tr);
      });
      renderSummary();
    }

    function formatPct(pct) { return pct.toFixed(2).replace(/\.00$/, "") + "%"; }

        function renderSummary() {
      // 1. Calculate Basic Stats
      const start = state.startDate || toISODate(new Date());
      const all = state.lectures.filter(lec => lec.date && lec.date >= start);
      const attended = all.filter(lec => lec.attended).length;
      const total = all.length;
      const pct = total > 0 ? ((attended / total) * 100).toFixed(2) : "0.00";


      // 2. Update the Header (Top Right Corner)
      if (summaryMainEl) summaryMainEl.textContent = `${attended} / ${total} lectures tracked`;
      if (summarySubEl) summarySubEl.textContent = `Overall: ${pct}%`;
      if (overallPillText) overallPillText.textContent = `${pct}%`;

      // 3. Calculate "Bunkable" vs "Lagging"
      // If we are ABOVE 75%, how many can we miss? 
      // Formula: (Attended - 0.75 * Total) / 0.75
      const canBunk = Math.floor((attended - 0.75 * total) / 0.75);
      
      // If we are BELOW 75%, how many do we need to attend?
      // Formula: (0.75 * Total - Attended) / 0.25
      const needToAttend = Math.ceil((0.75 * total - attended) / 0.25);

      // 4. Update the Home View Card (finalAttendanceSummary)
      const summaryDiv = document.getElementById('finalAttendanceSummary');
      
      if (summaryDiv) {
        let statusHtml = '';
        
        if (parseFloat(pct) >= 75) {

          statusHtml = `
            <div style="background:#dcfce7; color:#166534; padding:12px; border-radius:8px; margin-top:10px; border:1px solid #bbf7d0;">
              <strong>You are safe! üéâ</strong><br>
              You can skip the next <strong>${canBunk}</strong> lectures and stay above 75%.
            </div>`;
        } else {
          statusHtml = `
            <div style="background:#fee2e2; color:#991b1b; padding:12px; border-radius:8px; margin-top:10px; border:1px solid #fecaca;">
              <strong>Attendance Low ‚ö†Ô∏è</strong><br>
              You need to attend <strong>${needToAttend}</strong> more lectures in a row to hit 75%.
            </div>`;
        }

        const displayPct = parseFloat(pct); // Ensures we are checking the actual number

summaryDiv.innerHTML = `
  <div style="display:flex; align-items:center; justify-content:space-between; margin-top:5px;">
    <div class="pill" style="font-size:0.9rem; font-weight:700;">üéØ Overall: ${pct}%</div>
  </div>
  
  ${displayPct >= 75 ? `
    <div style="background:rgba(22, 163, 74, 0.1); color:#16a34a; padding:12px; border-radius:12px; margin-top:10px; border:1px solid rgba(22, 163, 74, 0.2); font-size:0.85rem;">
      <strong>Safe Zone! üéâ</strong><br>
      You are above the 75% limit.
    </div>
  ` : `
    <div style="background:rgba(220, 38, 38, 0.1); color:#dc2626; padding:12px; border-radius:12px; margin-top:10px; border:1px solid rgba(220, 38, 38, 0.2); font-size:0.85rem;">
      <strong>Below 75% ‚ö†Ô∏è</strong><br>
      You are currently at ${pct}%. Every lecture counts!
    </div>
  `}
`;

      }
    }


    function renderSubjectStats() {
      const start = state.startDate || toISODate(new Date());
      const all = state.lectures.filter(lec => lec.date && lec.date >= start);
      subjectStatsList.innerHTML = "";
      state.subjects.forEach(subj => {
        const subLecs = all.filter(l => l.subjectId === subj.id);
        const att = subLecs.filter(l => l.attended).length;
        const tot = subLecs.length;
        const pct = tot > 0 ? (att/tot)*100 : 0;
        
        const row = document.createElement("div"); row.className = "subject-stat-row";
        row.innerHTML = `
          <div class="subject-stat-name">${escapeHtml(subj.name)}</div>
          <div class="subject-stat-bar"><div class="subject-stat-bar-inner" style="width:${pct}%"></div></div>
          <div class="subject-stat-meta">${tot ? att+"/"+tot+" ‚Ä¢ "+formatPct(pct) : "No data"}</div>
        `;
        subjectStatsList.appendChild(row);
      });
    }

    function renderTimetable() {
      timetableBodyEl.innerHTML = "";
      state.subjects.forEach(subj => {
        const tr = document.createElement("tr");
        const nameTd = document.createElement("td"); nameTd.textContent = subj.name; nameTd.style.textAlign="left"; tr.appendChild(nameTd);
        
        if (!subj.schedule) subj.schedule = { weeklyPattern: [] };
        
        for (let d = 1; d <= 6; d++) {
          const td = document.createElement("td");
          const existing = subj.schedule.weeklyPattern.find(p => p.day === d);
          const count = existing ? existing.count : 0;
          
          const inp = document.createElement("input");
          inp.type="number"; inp.min=0; inp.max=6; inp.value=count;
          inp.addEventListener("change", () => {
            let val = parseInt(inp.value,10); if (isNaN(val) || val<0) val=0; if (val>6) val=6; inp.value=val;
            
            const idx = subj.schedule.weeklyPattern.findIndex(p => p.day === d);
            if (val === 0) {
               if (idx !== -1) subj.schedule.weeklyPattern.splice(idx, 1);
            } else {
               if (idx === -1) subj.schedule.weeklyPattern.push({ day: d, count: val });
               else subj.schedule.weeklyPattern[idx].count = val;
            }
            if (state.isInitialized) { regenerateFromSchedules(); saveState(); }
            renderCalendar(); renderLectures();
          });
          td.appendChild(inp); tr.appendChild(td);
        }
        timetableBodyEl.appendChild(tr);
      });
    }

    function switchView(viewId) {
      [homeView, dayView, timetableView].forEach(v => v.classList.toggle("active", v.id === viewId));
      navButtons.forEach(b => b.classList.toggle("active", b.dataset.view === viewId));
      
      if (viewId === "dayView") {
        selectedDate = new Date(); selectedDate.setHours(0,0,0,0);
        currentMonthDate = new Date(selectedDate); currentMonthDate.setDate(1); // Fix calendar jump
        subjectFilterEl.value = ""; // Fix hidden lectures
        autoLoadTodayLectures();
        renderCalendar(); 
        renderLectures();
      }
      localStorage.setItem(VIEW_KEY, viewId);
    }

    function autoLoadTodayLectures() {
      if (!state.isInitialized) return;
      const todayISO = toISODate(new Date());
      const loaded = state.lectures.some(l => l.date === todayISO && l.autoGenerated);
      if (!loaded) {
        generateLecturesForDate(todayISO);
        saveState();
      }
    }

    // Events
    studentNameInput.addEventListener("input", () => { state.studentName = studentNameInput.value; saveState(); renderStudent(); });
    startDateInput.addEventListener("change", () => {
      state.startDate = startDateInput.value || "2025-11-03";
      state.isInitialized = true;
      regenerateFromSchedules(); saveState(); renderCalendar(); renderLectures();
    });

    loadDayBtn.addEventListener("click", () => {
      subjectFilterEl.value = ""; // FIX: Reset filter so user sees results
      generateLecturesForDate(toISODate(selectedDate));
      saveState(); renderCalendar(); renderLectures();
    });

    addSubjectBtn.addEventListener("click", () => {
      const name = prompt("Subject name:");
      if (name) {
        state.subjects.push({ id: genId("sub"), name: name.trim(), schedule: { weeklyPattern: [] } });
        saveState(); renderSubjectsList(); renderTimetable();
      }
    });

    prevMonthBtn.addEventListener("click", () => { currentMonthDate.setMonth(currentMonthDate.getMonth()-1); renderCalendar(); });
    nextMonthBtn.addEventListener("click", () => { currentMonthDate.setMonth(currentMonthDate.getMonth()+1); renderCalendar(); });
    
    addLectureBtn.addEventListener("click", () => {
      const s = state.subjects[0];
      state.lectures.push({ id: genId("lec"), date: toISODate(selectedDate), subjectId: s?s.id:"", title:"", isSpecial:false, attended:true, autoGenerated:false });
      saveState(); renderLectures(); renderCalendar();
    });
    addSpecialLectureBtn.addEventListener("click", () => {
       const s = state.subjects[0];
       state.lectures.push({ id: genId("lec"), date: toISODate(selectedDate), subjectId: s?s.id:"", title:"Special lecture", isSpecial:true, attended:true, autoGenerated:false });
       saveState(); renderLectures(); renderCalendar();
    });

    markAllAttendedBtn.addEventListener("click", () => {
      const iso = toISODate(selectedDate);
      state.lectures.forEach(l => { if (l.date === iso) l.attended = true; });
      saveState(); renderLectures();
    });
    markAllAbsentBtn.addEventListener("click", () => {
      const iso = toISODate(selectedDate);
      state.lectures.forEach(l => { if (l.date === iso) l.attended = false; });
      saveState(); renderLectures();
    });

    subjectFilterEl.addEventListener("change", renderLectures);
    navButtons.forEach(b => b.addEventListener("click", () => switchView(b.dataset.view)));
    darkToggle.addEventListener("click", () => {
      const isDark = document.body.classList.contains("dark");
      setTheme(isDark ? "light" : "dark");
    });

    // Tutorial
    (function tutorialInit() {
      const backdrop = document.getElementById("tutorialModalBackdrop");
      const closeBtn = document.getElementById("tutorialCloseBtn");
      const check = document.getElementById("tutorialDismissCheckbox");
      const openDayBtn = document.getElementById("tutorialOpenDayBtn");
      const showBtn = document.getElementById("showTutorialNavBtn");
      
      if (showBtn) showBtn.addEventListener("click", startLiveTutorial);
      
      if (closeBtn) closeBtn.addEventListener("click", () => {
        if (check.checked) localStorage.setItem("attrack_tutorial_seen", "1");
        backdrop.style.display = "none";
        setTimeout(showTutorialReminder, 300);
      });
      
      if (openDayBtn) openDayBtn.addEventListener("click", () => {
        backdrop.style.display = "none";
        switchView("dayView");
      });

      // FIX: Ensure tutorial actually shows up
      if (!localStorage.getItem("attrack_tutorial_seen")) {
        setTimeout(() => backdrop.style.display = "flex", 500);
      }
    })();

    // Live Tutorial
    let tourIndex = 0, tourTooltip;
    const tourSteps = [
      { view: "homeView", selector: "#studentName", title: "Enter your name", text: "Start by entering your name here." },
      { view: "homeView", selector: "#startDate", title: "Start Date", text: "This is when attendance tracking begins." },
      { view: "dayView", selector: "#subjectsList", title: "Subjects", text: "Rename or remove subjects that don't apply to you." },
      { view: "dayView", selector: "#loadDayBtn", title: "Load Lectures", text: "Click this to generate the schedule for the selected day." },
      { view: "timetableView", selector: "#timetableBody", title: "Timetable", text: "Edit weekly counts here. Changes apply automatically." },
      { view: "homeView", selector: "#targetMessage", title: "Lectures you can miss", text: "This shows how many lectures you can miss." }

    ];

    function startLiveTutorial() { tourIndex=0; showTourStep(); }
    function showTourStep() {
      if (tourTooltip) tourTooltip.remove();
      const step = tourSteps[tourIndex];
      if (!step) return switchView("homeView");
      
      switchView(step.view);
      setTimeout(() => {
        const el = document.querySelector(step.selector);
        if (!el) return;
        el.scrollIntoView({behavior:"smooth", block:"center"});
        
        const rect = el.getBoundingClientRect();
        tourTooltip = document.createElement("div");
        tourTooltip.className = "tour-tooltip";
        tourTooltip.innerHTML = `<h4>${step.title}</h4><div>${step.text}</div><button class='btn small' id='tourNext'>${tourIndex===tourSteps.length-1?"Finish":"Next"}</button>`;
        document.body.appendChild(tourTooltip);
        
        // Position roughly
        tourTooltip.style.top = (rect.bottom + 10) + "px";
        tourTooltip.style.left = Math.max(10, rect.left) + "px";
        
        document.getElementById("tourNext").onclick = () => {
           tourIndex++; showTourStep();
        };
      }, 300);
    }
    
    function showTutorialReminder() {
       // Simple reminder logic (omitted for brevity, code provided in original was fine)
    }

    // Boot
    (function init() {
      setTheme(localStorage.getItem(THEME_KEY) || "light");
      if (!state.isInitialized) {
         state.isInitialized = true;
         // Pre-generate a few weeks if fresh
         const start = parseISO(state.startDate);
         const end = new Date();
         for(let d=new Date(start); d<=end; d.setDate(d.getDate()+1)) {
            generateLecturesForDate(toISODate(d));
         }
         saveState();
      }
      // Ensure "Today" is loaded
      autoLoadTodayLectures();
      
      renderStudent();
      renderSubjectsList();
      renderSubjectStats();
      renderTimetable();
      renderSummary();
    })();

  })();

  // Share
  const shareBtn = document.getElementById("shareAppBtn");
  const shareStatus = document.getElementById("shareStatus");
  if (shareBtn) {
    shareBtn.addEventListener("click", async () => {
      if (navigator.share) {
        try { await navigator.share({ title: "Attrack", url: window.location.href }); } catch(e){}
      } else {
        navigator.clipboard.writeText(window.location.href);
        shareStatus.style.display = "inline";
        setTimeout(() => shareStatus.style.display="none", 2000);
      }
    });
  }
</script><!-- hits.sh counter (can be invisible if you want) -->
<img
  src="https://hits.sh/jenishestmoizavut.github.io/Attrack-FYBFM-Edition-/.svg"
  alt="Hits"
  style="display:none"
/>
<script>
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("./sw.js");
  }
</script>
<script>
(function () {
  try {
    const today = new Date().toISOString().slice(0, 10);
    const lastPing = localStorage.getItem("attrack_last_ping");

    if (lastPing !== today) {
      fetch(
        "https://hits.sh/jenishestmoizavut.github.io/Attrack-FYBFM-Edition-/.svg",
        { cache: "no-store" }
      );
      localStorage.setItem("attrack_last_ping", today);
    }
  } catch (e) {
    // fail silently ‚Äî never block the app
  }
})();
</script>
</body>
</html>
